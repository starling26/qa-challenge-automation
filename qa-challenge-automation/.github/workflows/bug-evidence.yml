name: 🐛 Bug Evidence Capture - Failing Tests

on:
  workflow_dispatch:
    inputs:
      test_case:
        description: 'Test específico para capturar evidencia'
        required: true
        default: 'all-failing'
        type: choice
        options:
          - all-failing
          - tc08-phone-bug
          - tc03-email-bug
          - tc013-login-issue
          - tc018-transfer-incomplete
  schedule:
    # Capturar evidencias todos los lunes a las 9:00 AM UTC
    - cron: '0 9 * * 1'

env:
  BASE_URL: https://parabank.parasoft.com/parabank

jobs:
  capture-bug-evidence:
    name: 📸 Capture Bug Evidence
    runs-on: ubuntu-latest
    strategy:
      matrix:
        browser: [chromium, firefox]
        include:
          - browser: chromium
            headed: true
          - browser: firefox
            headed: false
    steps:
      - name: 📥 Checkout repository
        uses: actions/checkout@v4

      - name: 🟢 Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: '18'
          cache: 'npm'

      - name: 📦 Install dependencies
        run: npm ci

      - name: 🎭 Install Playwright browsers
        run: npx playwright install --with-deps ${{ matrix.browser }}

      - name: 📁 Create evidence directories
        run: |
          mkdir -p screenshots/evidence
          mkdir -p screenshots/bugs
          mkdir -p screenshots/validation

      - name: 🐛 TC08 - Phone Field Bug Evidence
        if: github.event.inputs.test_case == 'tc08-phone-bug' || github.event.inputs.test_case == 'all-failing'
        run: |
          npx playwright test --grep "TC08.*telephone field must accept only numbers" \
            --project=${{ matrix.browser }} \
            --reporter=html \
            --output-dir=screenshots/bugs/tc08
        continue-on-error: true

      - name: 📧 TC03 - Email Validation Bug Evidence
        if: github.event.inputs.test_case == 'tc03-email-bug' || github.event.inputs.test_case == 'all-failing'
        run: |
          npx playwright test --grep "TC03.*invalid email format" \
            --project=${{ matrix.browser }} \
            --reporter=html \
            --output-dir=screenshots/bugs/tc03
        continue-on-error: true

      - name: 🔐 TC013 - Login Credentials Issue Evidence
        if: github.event.inputs.test_case == 'tc013-login-issue' || github.event.inputs.test_case == 'all-failing'
        run: |
          npx playwright test --grep "TC_AUTO_013.*correct page load after login" \
            --project=${{ matrix.browser }} \
            --reporter=html \
            --output-dir=screenshots/bugs/tc013
        continue-on-error: true

      - name: 💰 TC018 - Transfer Validation Incomplete Evidence
        if: github.event.inputs.test_case == 'tc018-transfer-incomplete' || github.event.inputs.test_case == 'all-failing'
        run: |
          npx playwright test --grep "TC_AUTO_018.*successful transfer" \
            --project=${{ matrix.browser }} \
            --reporter=html \
            --output-dir=screenshots/bugs/tc018
        continue-on-error: true

      - name: 📊 Generate Bug Evidence Report
        run: |
          echo "# 🐛 Bug Evidence Report" > bug-evidence-report.md
          echo "" >> bug-evidence-report.md
          echo "**Generated**: $(date)" >> bug-evidence-report.md
          echo "**Browser**: ${{ matrix.browser }}" >> bug-evidence-report.md
          echo "**Commit**: ${{ github.sha }}" >> bug-evidence-report.md
          echo "" >> bug-evidence-report.md
          
          echo "## 📸 Evidence Captured" >> bug-evidence-report.md
          echo "" >> bug-evidence-report.md
          
          if ls screenshots/tc08-phone-* >/dev/null 2>&1; then
            echo "### 🐛 TC08 - Phone Field Bug" >> bug-evidence-report.md
            echo "- **Issue**: Phone field accepts alphabetic characters" >> bug-evidence-report.md
            echo "- **Expected**: Should only accept numbers" >> bug-evidence-report.md
            echo "- **Evidence**: $(ls screenshots/tc08-phone-* | wc -l) screenshots captured" >> bug-evidence-report.md
            echo "" >> bug-evidence-report.md
          fi
          
          if ls screenshots/tc03-email-* >/dev/null 2>&1; then
            echo "### 📧 TC03 - Email Validation Bug" >> bug-evidence-report.md
            echo "- **Issue**: Invalid email format accepted" >> bug-evidence-report.md
            echo "- **Expected**: Should reject emails without TLD" >> bug-evidence-report.md
            echo "- **Evidence**: $(ls screenshots/tc03-email-* | wc -l) screenshots captured" >> bug-evidence-report.md
            echo "" >> bug-evidence-report.md
          fi
          
          if ls screenshots/tc013-login-* >/dev/null 2>&1; then
            echo "### 🔐 TC013 - Login Credentials Issue" >> bug-evidence-report.md
            echo "- **Issue**: Test credentials jsmith/demo123 are invalid" >> bug-evidence-report.md
            echo "- **Impact**: All account-related tests fail" >> bug-evidence-report.md
            echo "- **Evidence**: $(ls screenshots/tc013-login-* | wc -l) screenshots captured" >> bug-evidence-report.md
            echo "" >> bug-evidence-report.md
          fi
          
          if ls screenshots/tc018-* >/dev/null 2>&1; then
            echo "### 💰 TC018 - Transfer Validation Incomplete" >> bug-evidence-report.md
            echo "- **Issue**: Test doesn't verify actual balance changes" >> bug-evidence-report.md
            echo "- **Gap**: Only validates form submission, not financial transaction" >> bug-evidence-report.md
            echo "- **Evidence**: $(ls screenshots/tc018-* | wc -l) screenshots captured" >> bug-evidence-report.md
            echo "" >> bug-evidence-report.md
          fi
          
          echo "## 📁 Files Generated" >> bug-evidence-report.md
          echo "\`\`\`" >> bug-evidence-report.md
          find screenshots/ -name "*.png" -type f | sort >> bug-evidence-report.md
          echo "\`\`\`" >> bug-evidence-report.md

      - name: 📸 Archive bug evidence
        uses: actions/upload-artifact@v4
        with:
          name: bug-evidence-${{ matrix.browser }}-${{ github.run_number }}
          path: |
            screenshots/
            bug-evidence-report.md
            playwright-report/
          retention-days: 90

      - name: 📊 Upload detailed HTML report
        uses: actions/upload-artifact@v4
        with:
          name: bug-evidence-html-report-${{ matrix.browser }}
          path: playwright-report/
          retention-days: 90

  consolidate-evidence:
    name: 📋 Consolidate Bug Evidence
    runs-on: ubuntu-latest
    needs: capture-bug-evidence
    steps:
      - name: 📥 Checkout repository
        uses: actions/checkout@v4

      - name: 📥 Download all evidence
        uses: actions/download-artifact@v4
        with:
          path: ./evidence

      - name: 📊 Create master bug report
        run: |
          echo "# 🎭 ParaBank Bug Evidence - Master Report" > master-bug-report.md
          echo "" >> master-bug-report.md
          echo "**Generated**: $(date)" >> master-bug-report.md
          echo "**Workflow Run**: ${{ github.run_number }}" >> master-bug-report.md
          echo "**Triggered by**: ${{ github.event_name }}" >> master-bug-report.md
          echo "" >> master-bug-report.md
          
          echo "## 🎯 Summary of Bugs Documented" >> master-bug-report.md
          echo "" >> master-bug-report.md
          
          total_screenshots=$(find ./evidence -name "*.png" -type f | wc -l)
          echo "- **Total screenshots captured**: $total_screenshots" >> master-bug-report.md
          echo "- **Browsers tested**: Chromium, Firefox" >> master-bug-report.md
          echo "- **Test categories**: Contact Form, Account Management, Fund Transfer" >> master-bug-report.md
          echo "" >> master-bug-report.md
          
          echo "## 🐛 Critical Issues Identified" >> master-bug-report.md
          echo "" >> master-bug-report.md
          echo "### Priority 1 - Application Bugs" >> master-bug-report.md
          echo "1. **TC08 - Phone Field Validation**: Accepts alphabetic characters" >> master-bug-report.md
          echo "2. **TC03 - Email Format Validation**: Accepts invalid email formats" >> master-bug-report.md
          echo "" >> master-bug-report.md
          echo "### Priority 2 - Test Infrastructure" >> master-bug-report.md
          echo "3. **TC013 - Login Credentials**: Test credentials are invalid" >> master-bug-report.md
          echo "4. **TC018 - Transfer Validation**: Incomplete financial validation" >> master-bug-report.md
          echo "" >> master-bug-report.md
          
          echo "## 📁 Evidence Files" >> master-bug-report.md
          echo "" >> master-bug-report.md
          echo "\`\`\`" >> master-bug-report.md
          find ./evidence -type f -name "*.png" | sort >> master-bug-report.md
          echo "\`\`\`" >> master-bug-report.md
          echo "" >> master-bug-report.md
          
          echo "## 🔗 Access Instructions" >> master-bug-report.md
          echo "" >> master-bug-report.md
          echo "1. Download artifacts from GitHub Actions run" >> master-bug-report.md
          echo "2. Extract bug-evidence-* folders" >> master-bug-report.md
          echo "3. Open playwright-report/index.html for detailed results" >> master-bug-report.md
          echo "4. Screenshots are organized by test case in screenshots/ folder" >> master-bug-report.md
          echo "" >> master-bug-report.md
          
          echo "## 📈 Recommended Actions" >> master-bug-report.md
          echo "" >> master-bug-report.md
          echo "### For Development Team:" >> master-bug-report.md
          echo "- Fix phone field validation (TC08)" >> master-bug-report.md
          echo "- Implement proper email format validation (TC03)" >> master-bug-report.md
          echo "" >> master-bug-report.md
          echo "### For QA Team:" >> master-bug-report.md
          echo "- Update test credentials (TC013)" >> master-bug-report.md
          echo "- Enhance transfer validation to check actual balance changes (TC018)" >> master-bug-report.md

      - name: 📊 Upload master report
        uses: actions/upload-artifact@v4
        with:
          name: master-bug-evidence-report
          path: |
            master-bug-report.md
            evidence/
          retention-days: 180

      - name: 🚀 Create GitHub Issue (if bugs found)
        uses: actions/github-script@v7
        with:
          script: |
            const fs = require('fs');
            const reportContent = fs.readFileSync('master-bug-report.md', 'utf8');
            
            // Buscar issues existentes
            const existingIssues = await github.rest.issues.listForRepo({
              owner: context.repo.owner,
              repo: context.repo.repo,
              labels: 'bug-evidence,automated',
              state: 'open'
            });
            
            if (existingIssues.data.length === 0) {
              // Crear nuevo issue si no existe uno abierto
              await github.rest.issues.create({
                owner: context.repo.owner,
                repo: context.repo.repo,
                title: `🐛 Automated Bug Evidence Report - Run #${{ github.run_number }}`,
                body: reportContent,
                labels: ['bug-evidence', 'automated', 'needs-review']
              });
            } else {
              // Actualizar issue existente
              await github.rest.issues.createComment({
                owner: context.repo.owner,
                repo: context.repo.repo,
                issue_number: existingIssues.data[0].number,
                body: `## 📸 New Evidence Captured - Run #${{ github.run_number }}\n\n${reportContent}`
              });
            }
